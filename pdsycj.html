<!DOCTYPE html>
<html>

<head>
    <title>上传</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css">
</head>

<body>
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-6">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <div class="text-center">
                            <label for="fileInput" class="form-label">选择文件</label>
                        </div>
                        <input type="file" id="fileInput" name="file" class="form-control">
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">上传</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="text-center mt-3">
        <div id="imageContainer"></div>
        <div id="imageLink" class="mt-3"></div>
        <button id="copyButton" class="btn btn-secondary mt-2" onclick="copyImageUrl()">复制链接</button>
    </div>

    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.16.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var uploadForm = document.getElementById('uploadForm');
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // 阻止表单提交
                var fileInput = document.getElementById('fileInput');
                var file = fileInput.files[0]; // 获取用户选择的文件
                const fileName = file.name;

                try {
                    const res = await fetch('/getsign');
                    const ossParams = await res.json();

                    const client = new OSS({
                        region: 'oss-cn-hongkong',
                        accessKeyId: ossParams.data.tempAk,
                        accessKeySecret: ossParams.data.tempSk,
                        stsToken: ossParams.data.token,
                        bucket: 'xlt-object'
                    });

                    const result = await client.put(`/user/2023-08-17/${fileName}`, file);
                    console.log(result);
                    const imageUrl = result.url;
                    var imageElement = document.createElement('img');
                    imageElement.src = imageUrl;
                    imageElement.alt = '已上传的图像';
                    var imageContainer = document.getElementById('imageContainer');
                    imageContainer.innerHTML = ''; // 清除之前的内容
                    imageContainer.appendChild(imageElement);

                    var imageLink = document.getElementById('imageLink');
                    imageLink.innerHTML = 'url：<a href="' + imageUrl + '" target="_blank">' + imageUrl + '</a>';

                    alert("文件上传成功！");
                } catch (e) {
                    console.error(e);
                    alert("文件上传失败！");
                }
            });
        });

        function copyImageUrl() {
            var imageUrl = document.getElementById('imageLink').querySelector('a').getAttribute('href');
            var dummy = document.createElement('textarea');
            document.body.appendChild(dummy);
            dummy.value = imageUrl;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert('链接已复制！');
        }
    </script>
</body>

</html>
